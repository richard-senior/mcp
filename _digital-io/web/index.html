<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital I/O Bank Status</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            max-width: 800px;
            margin: 0 auto;
            background-color: #f5f5f5;
        }
        h1 {
            font-size: 18px;
            margin: 0 0 10px 0;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .io-section {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            background-color: white;
        }
        .io-section h2 {
            font-size: 14px;
            margin: 0 0 8px 0;
            color: #555;
        }
        .io-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 3px;
            max-width: 400px; /* Reduce overall width by ~30% */
        }
        .io-grid.digital-inputs {
            grid-template-columns: repeat(8, 1fr);
        }
        .io-grid.digital-outputs {
            grid-template-columns: repeat(8, 1fr);
        }
        .io-grid.analog {
            grid-template-columns: repeat(4, 1fr);
            max-width: 200px;
        }
        .io-item {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
            position: relative;
            overflow: hidden;
        }
        .io-item.digital {
            cursor: default;
        }
        .io-item.output {
            cursor: pointer;
        }
        .io-item.on {
            background-color: #4caf50;
        }
        .io-item.off {
            background-color: #f44336;
        }
        .io-item .label {
            position: absolute;
            top: 1px;
            left: 1px;
            font-size: 7px;
            color: rgba(255, 255, 255, 0.8);
        }
        .io-item .name {
            position: absolute;
            bottom: 1px;
            left: 0;
            right: 0;
            font-size: 6px;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 2px;
        }
        .analog-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px;
            max-width: 200px; /* Reduce size by ~30% */
        }
        .analog-item {
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 4px;
            text-align: center;
            background-color: #e8f5e9;
            font-size: 10px;
            position: relative;
        }
        .analog-item .label {
            position: absolute;
            top: 1px;
            left: 3px;
            font-size: 7px;
            color: #555;
        }
        .analog-item .value {
            font-weight: bold;
            color: #333;
            margin-top: 2px;
        }
        .analog-item .name {
            font-size: 7px;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }
        .analog-output {
            background-color: #e3f2fd;
            cursor: pointer;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            margin-top: 10px;
            color: #555;
        }
        .message-box {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 12px;
            background-color: white;
            margin-bottom: 15px;
            min-height: 20px;
            max-height: 40px;
            overflow: hidden;
        }
        .message-box h3 {
            font-size: 14px;
            margin: 0 0 6px 0;
            color: #333;
        }
        .message-list {
            font-size: 12px;
            line-height: 1.2;
        }
        .message-item {
            margin: 0;
            padding: 2px 4px;
            border-radius: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .message-alarm {
            background-color: #ffebee;
            color: #c62828;
            border-left: 3px solid #f44336;
        }
        .message-status {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-left: 3px solid #4caf50;
        }
        .message-info {
            background-color: #e3f2fd;
            color: #1565c0;
            border-left: 3px solid #2196f3;
        }
        .message-mcp {
            background-color: #f3e5f5;
            color: #7b1fa2;
            border-left: 3px solid #9c27b0;
        }
        .reset-button {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        .reset-button:hover {
            background-color: #d32f2f;
        }
        .reset-button:active {
            background-color: #b71c1c;
        }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-active {
            background-color: #4CAF50;
        }
        .status-inactive {
            background-color: #f44336;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
            border-radius: 5px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .modal-title {
            margin-top: 0;
            font-size: 16px;
        }
        .modal-input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            box-sizing: border-box;
        }
        .modal-button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .modal-button:hover {
            background-color: #45a049;
        }
        
        /* Scrollbar styles */
        pre::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        pre::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        pre::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
            border: 3px solid #f1f1f1;
        }
        
        pre::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        pre {
            scrollbar-width: thin;
            scrollbar-color: #888 #f1f1f1;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 400px;
            max-width: 100%;
            padding: 10px;
            margin: 10px 0;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        code {
            display: block;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>
        <span>Digital I/O Bank Status</span>
        <button class="reset-button" onclick="resetSystem()">🔄 Reset System</button>
    </h1>
    
    <!-- Message Box for Warnings Only -->
    <div class="message-box">
        <h3>System Warnings</h3>
        <div class="message-list" id="message-list">
            <div class="message-item message-info">✅ System operating normally - No warnings</div>
        </div>
    </div>
    
    <div class="status-container">
        <div class="io-section">
            <h2>Digital Inputs (0-7)</h2>
            <div class="io-grid digital-inputs" id="digital-inputs"></div>
        </div>
        
        <div class="io-section">
            <h2>Digital Outputs (0-15)</h2>
            <div class="io-grid digital-outputs" id="digital-outputs"></div>
        </div>
        
        <div class="io-section">
            <h2>Analog Inputs (0-3)</h2>
            <div class="analog-grid analog" id="analog-inputs"></div>
        </div>
        
        <div class="io-section">
            <h2>Analog Outputs (0-3)</h2>
            <div class="analog-grid analog" id="analog-outputs"></div>
        </div>
    </div>
    
    <div class="status-bar">
        <div>
            <span>Simulation: </span>
            <span class="status-indicator" id="simulation-status"></span>
            <span id="simulation-text">Unknown</span>
        </div>
        <div>Last updated: <span id="last-updated">-</span></div>
    </div>

    <!-- Modal for setting analog output value -->
    <div id="analog-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 class="modal-title">Set Analog Output <span id="analog-pin-number"></span></h3>
            <input type="range" id="analog-value-slider" class="modal-input" min="0" max="5" step="0.1" value="0">
            <div style="text-align: center; margin-bottom: 10px;"><span id="analog-value-display">0.0</span> V</div>
            <button id="set-analog-value" class="modal-button">Set Value</button>
        </div>
    </div>

    <script>
        // Global variables
        let ioLabels = {
            digital_inputs: {},
            digital_outputs: {},
            analog_inputs: {},
            analog_outputs: {}
        };
        let analogRanges = {
            inputs: {},
            outputs: {}
        };
        let previousState = {
            digitalOutputs: new Array(16).fill(false), // Track previous DO states for edge detection
            digitalInputs: new Array(8).fill(false), // Track previous DI states
            milkDispensed: false // Track if milk has been dispensed into current cup
        };
        
        // Reset milk dispensed flag when cup is removed or new cup dispensed
        function updateMilkTrackingForCup(cupPresent, fallingEdges) {
            // Reset milk tracking when new cup is dispensed
            if (fallingEdges.includes(4)) {
                previousState.milkDispensed = false;
            }
            
            // Reset milk tracking when cup is removed
            if (!cupPresent && previousState.cupPresent) {
                previousState.milkDispensed = false;
            }
            
            previousState.cupPresent = cupPresent;
        }
        
        // Detect falling edge (high to low transition) for pulsed dispensers
        function detectFallingEdges(currentOutputs) {
            const fallingEdges = [];
            
            for (let i = 0; i < currentOutputs.length; i++) {
                // Falling edge: was high, now low
                if (previousState.digitalOutputs[i] === true && currentOutputs[i] === false) {
                    fallingEdges.push(i);
                }
            }
            
            // Update previous state
            previousState.digitalOutputs = [...currentOutputs];
            
            return fallingEdges;
        }
        
        // Detect cup contents based on weight and dispensing history (simplified for warnings only)
        function analyzeCupContents(cupWeight, digitalInputs, digitalOutputs) {
            const analysis = {
                hasWater: cupWeight >= 50,
                hasMilk: previousState.milkDispensed
            };
            
            return analysis;
        }
        
        // Convert voltage to actual units
        function convertAnalogValue(voltage, pin, isOutput = false) {
            const ranges = isOutput ? analogRanges.outputs : analogRanges.inputs;
            const range = ranges[pin.toString()];
            
            if (range) {
                const minVal = parseFloat(range.min_value);
                const maxVal = parseFloat(range.max_value);
                const actualValue = minVal + (voltage / 5.0) * (maxVal - minVal);
                return {
                    value: actualValue.toFixed(2),
                    unit: range.unit
                };
            }
            
            // Default to voltage if no range defined
            return {
                value: voltage.toFixed(3),
                unit: 'V'
            };
        }
        
        // Initialize the UI
        function initUI() {
            // Create digital inputs
            const digitalInputs = document.getElementById('digital-inputs');
            for (let i = 0; i < 8; i++) {
                const item = document.createElement('div');
                item.className = 'io-item digital off';
                item.id = `di-${i}`;
                item.innerHTML = `
                    <span class="label">DI${i}</span>
                    ${i}
                    <span class="name"></span>
                `;
                digitalInputs.appendChild(item);
            }
            
            // Create digital outputs
            const digitalOutputs = document.getElementById('digital-outputs');
            for (let i = 0; i < 16; i++) {
                const item = document.createElement('div');
                item.className = 'io-item digital output off';
                item.id = `do-${i}`;
                item.innerHTML = `
                    <span class="label">DO${i}</span>
                    ${i}
                    <span class="name"></span>
                `;
                item.addEventListener('click', () => {
                    toggleDigitalOutput(i);
                });
                digitalOutputs.appendChild(item);
            }
            
            // Create analog inputs
            const analogInputs = document.getElementById('analog-inputs');
            for (let i = 0; i < 4; i++) {
                const item = document.createElement('div');
                item.className = 'analog-item';
                item.id = `ai-${i}`;
                item.innerHTML = `
                    <span class="label">AI${i}</span>
                    <div class="value">0.00V</div>
                    <div class="name"></div>
                `;
                analogInputs.appendChild(item);
            }
            
            // Create analog outputs
            const analogOutputs = document.getElementById('analog-outputs');
            for (let i = 0; i < 4; i++) {
                const item = document.createElement('div');
                item.className = 'analog-item analog-output';
                item.id = `ao-${i}`;
                item.innerHTML = `
                    <span class="label">AO${i}</span>
                    <div class="value">0.00V</div>
                    <div class="name"></div>
                `;
                item.addEventListener('click', () => {
                    if (!editMode) {
                        showAnalogModal(i);
                    }
                });
                analogOutputs.appendChild(item);
            }

            // Set up analog modal
            const analogModal = document.getElementById('analog-modal');
            const analogCloseBtn = analogModal.querySelector('.close');
            const slider = document.getElementById('analog-value-slider');
            const valueDisplay = document.getElementById('analog-value-display');
            const setButton = document.getElementById('set-analog-value');

            analogCloseBtn.onclick = () => {
                analogModal.style.display = 'none';
            };

            slider.oninput = function() {
                valueDisplay.textContent = parseFloat(this.value).toFixed(1);
            };
            
            // Close modals when clicking outside
            window.onclick = (event) => {
                if (event.target === analogModal) {
                    analogModal.style.display = 'none';
                }
            };

            // Initial data load
            refreshData();
            
            // Set up periodic refresh
            setInterval(refreshData, 1000);
        }
        
        
        // Update label display in UI
        function updateLabelDisplay(type, pin, label) {
            console.log(`updateLabelDisplay called: type=${type}, pin=${pin}, label=${label}`);
            let element;
            let elementId;
            switch (type) {
                case 'digital_input':
                    elementId = `di-${pin}`;
                    element = document.getElementById(elementId);
                    break;
                case 'digital_output':
                    elementId = `do-${pin}`;
                    element = document.getElementById(elementId);
                    break;
                case 'analog_input':
                    elementId = `ai-${pin}`;
                    element = document.getElementById(elementId);
                    break;
                case 'analog_output':
                    elementId = `ao-${pin}`;
                    element = document.getElementById(elementId);
                    break;
            }
            
            console.log(`Looking for element with ID: ${elementId}`);
            console.log(`Element found:`, element);
            
            if (element) {
                const nameElement = element.querySelector('.name');
                console.log(`Name element found:`, nameElement);
                if (nameElement) {
                    console.log(`Setting textContent from "${nameElement.textContent}" to "${label}"`);
                    nameElement.textContent = label;
                    nameElement.title = label; // For tooltip on hover
                    console.log(`Updated label for ${elementId} to: ${label}`);
                    console.log(`Verification - nameElement.textContent is now: "${nameElement.textContent}"`);
                } else {
                    console.error(`No .name element found in ${elementId}. Element innerHTML:`, element.innerHTML);
                }
            } else {
                console.error(`No element found with ID: ${elementId}`);
                // List all elements with similar IDs for debugging
                const allElements = document.querySelectorAll(`[id^="${type.replace('_', '-')}-"]`);
                console.log(`Available ${type} elements:`, Array.from(allElements).map(el => el.id));
            }
        }
        
        // Refresh all I/O data
        async function refreshData() {
            try {
                // Add cache-busting parameter to ensure fresh data
                const cacheBuster = Date.now();
                const response = await fetch(`/status?_=${cacheBuster}`);
                const data = await response.json();
                updateUI(data);
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }
        
        // Update the UI with data
        function updateUI(data) {
            // Update digital inputs
            const digitalInputs = data.digital_inputs;
            for (let i = 0; i < digitalInputs.length; i++) {
                const element = document.getElementById(`di-${i}`);
                if (element) {
                    element.classList.remove('on', 'off');
                    element.classList.add(digitalInputs[i] ? 'on' : 'off');
                }
            }
            
            // Update digital outputs
            const digitalOutputs = data.digital_outputs;
            for (let i = 0; i < digitalOutputs.length; i++) {
                const element = document.getElementById(`do-${i}`);
                if (element) {
                    element.classList.remove('on', 'off');
                    element.classList.add(digitalOutputs[i] ? 'on' : 'off');
                }
            }
            
            // Update analog inputs
            const analogInputs = data.analog_inputs;
            for (let i = 0; i < analogInputs.length; i++) {
                const element = document.getElementById(`ai-${i}`);
                if (element) {
                    const converted = convertAnalogValue(analogInputs[i], i, false);
                    element.querySelector('.value').textContent = `${converted.value}${converted.unit} (${analogInputs[i].toFixed(3)}V)`;
                }
            }
            
            // Update analog outputs
            const analogOutputs = data.analog_outputs;
            for (let i = 0; i < analogOutputs.length; i++) {
                const element = document.getElementById(`ao-${i}`);
                if (element) {
                    const converted = convertAnalogValue(analogOutputs[i], i, true);
                    element.querySelector('.value').textContent = `${converted.value}${converted.unit} (${analogOutputs[i].toFixed(3)}V)`;
                }
            }
            
            // Update simulation status
            const simulationActive = data.simulation_running;
            const indicator = document.getElementById('simulation-status');
            const text = document.getElementById('simulation-text');
            
            indicator.className = 'status-indicator';
            indicator.classList.add(simulationActive ? 'status-active' : 'status-inactive');
            text.textContent = simulationActive ? 'Running' : 'Stopped';
            
            // Update labels if present
            if (data.labels) {
                console.log('Labels received:', data.labels);
                ioLabels = data.labels;
                
                // Update digital input labels
                for (const [pin, label] of Object.entries(ioLabels.digital_inputs)) {
                    console.log(`Updating digital input ${pin}: ${label}`);
                    updateLabelDisplay('digital_input', pin, label);
                }
                
                // Update digital output labels
                for (const [pin, label] of Object.entries(ioLabels.digital_outputs)) {
                    console.log(`Updating digital output ${pin}: ${label}`);
                    updateLabelDisplay('digital_output', pin, label);
                }
                
                // Update analog input labels
                for (const [pin, label] of Object.entries(ioLabels.analog_inputs)) {
                    console.log(`Updating analog input ${pin}: ${label}`);
                    updateLabelDisplay('analog_input', pin, label);
                }
                
                // Update analog output labels
                for (const [pin, label] of Object.entries(ioLabels.analog_outputs)) {
                    console.log(`Updating analog output ${pin}: ${label}`);
                    updateLabelDisplay('analog_output', pin, label);
                }
            } else {
                console.log('No labels found in data:', data);
            }
            
            // Update analog ranges if present
            if (data.analog_ranges) {
                analogRanges = data.analog_ranges;
            }
            
            // Generate and update system messages
            updateSystemMessages(data);
        }
        
        // Generate system messages based on current state
        function updateSystemMessages(data) {
            const messages = [];
            
            const digitalInputs = data.digital_inputs;
            const digitalOutputs = data.digital_outputs;
            const analogInputs = data.analog_inputs;
            
            // Convert analog values to meaningful units (updated pin assignments)
            const kettleTemp = analogInputs[1] * 20.0; // AI1: 0-5V = 0-100°C
            const cupWeight = analogInputs[2] * 200.0; // AI2: 0-5V = 0-1000g
            const kettleWeight = analogInputs[3] * 400.0; // AI3: 0-5V = 0-2000g
            
            // Detect falling edges for pulsed dispensers
            const fallingEdges = detectFallingEdges(digitalOutputs);
            
            // Update previous digital input state for next comparison
            previousState.digitalInputs = [...digitalInputs];
            
            // Update milk tracking based on cup state and dispensing (DI1 = cup present)
            updateMilkTrackingForCup(digitalInputs[1], fallingEdges);
            
            // Track milk dispensing - if milk dispenser is active and cup is present (DO7, DI1)
            if (digitalOutputs[7] && digitalInputs[1]) {
                previousState.milkDispensed = true;
            }
            
            // Analyze cup contents
            const cupContents = analyzeCupContents(cupWeight, digitalInputs, digitalOutputs);
            
            // ONLY ALARM/WARNING MESSAGES
            
            // Double cup dispensing - falling edge on DO4 when cup already present (DI1)
            if (fallingEdges.includes(4) && digitalInputs[1]) {
                messages.push({
                    type: 'alarm',
                    text: '⚠️ Cup dispenser pulsed but cup already present - double dispensing attempt'
                });
            }
            
            // Double teabag dispensing - falling edge on DO5 when teabag already detected
            if (fallingEdges.includes(5) && digitalInputs[1] && digitalInputs[5]) {
                messages.push({
                    type: 'alarm',
                    text: '⚠️ Teabag dispenser pulsed but teabag already in cup - double dispensing'
                });
            }
            
            // Tea etiquette warnings - only on falling edges (actual dispensing events)
            
            // Sugar added to cup with teabag (on sugar dispense pulse DO6)
            if (fallingEdges.includes(6) && digitalInputs[1] && digitalInputs[5]) {
                messages.push({
                    type: 'alarm',
                    text: '⚠️ Sweet teabag.. tut tut'
                });
            }
            
            // Sugar added after milk (on sugar dispense pulse DO6)
            if (fallingEdges.includes(6) && digitalInputs[1] && cupContents.hasMilk) {
                messages.push({
                    type: 'alarm',
                    text: '⚠️ Oh, milk before sugar.. grim'
                });
            }
            
            // Teabag dispensing into liquid (on teabag dispense pulse DO5)
            if (fallingEdges.includes(5) && digitalInputs[1] && cupContents.hasWater && !digitalInputs[5]) {
                messages.push({
                    type: 'alarm',
                    text: '⚠️ Adding teabag to liquid - teabag should be added before water for proper brewing'
                });
            }
            
            // Kettle heating with no/low water (DO3 = kettle power relay)
            if (digitalOutputs[3] && kettleWeight < 100) {
                messages.push({
                    type: 'alarm',
                    text: `⚠️ Kettle heating with insufficient water (${kettleWeight.toFixed(0)}g < 100g)`
                });
            }
            
            // Water pouring with no cup (DO2 = kettle outlet valve, DI1 = cup present)
            if (digitalOutputs[2] && !digitalInputs[1] && kettleWeight > 0) {
                messages.push({
                    type: 'alarm',
                    text: '⚠️ Water pouring with no cup present - spillage occurring'
                });
            }
            
            // Milk dispensing with no cup (DO7 = milk dispenser, DI1 = cup present)
            if (digitalOutputs[7] && !digitalInputs[1]) {
                messages.push({
                    type: 'alarm',
                    text: '⚠️ Milk dispensing with no cup present - spillage occurring'
                });
            }
            
            // Cup overflow
            if (cupWeight >= 300) {
                messages.push({
                    type: 'alarm',
                    text: '⚠️ Cup overflow - maximum capacity (300g) reached'
                });
            }
            
            // Both inlet and outlet valves open (DO1 = inlet, DO2 = outlet)
            if (digitalOutputs[1] && digitalOutputs[2]) {
                messages.push({
                    type: 'alarm',
                    text: '⚠️ Both kettle inlet and outlet valves open simultaneously'
                });
            }
            
            // Teaspoon operation alarms (DO8 = height, DO9 = stir, DO10 = squash, DI2 = in cup, DI3 = stirring, DI4 = squashing)
            
            // Stirring without teaspoon in cup (DO9 = stir, DI2 = teaspoon in cup)
            if (digitalOutputs[9] && !digitalInputs[2]) {
                messages.push({
                    type: 'alarm',
                    text: '⚠️ Stirring activated but teaspoon not in cup'
                });
            }
            
            // Squashing command without teaspoon in cup (DO10 = squash, DI4 = squashing)
            if (digitalOutputs[10] && !digitalInputs[4]) {
                messages.push({
                    type: 'alarm',
                    text: '⚠️ Squashing command active but teaspoon not squashing (not in cup?)'
                });
            }
            
            // Stirring and squashing simultaneously (DO9 = stir, DI4 = squashing)
            if (digitalOutputs[9] && digitalInputs[4]) {
                messages.push({
                    type: 'alarm',
                    text: '⚠️ Stirring while squashing - not recommended'
                });
            }
            
            // Update the message display
            displayMessages(messages);
        }
        
        // Display messages in the message box
        function displayMessages(messages) {
            const messageList = document.getElementById('message-list');
            
            // Clear existing messages
            messageList.innerHTML = '';
            
            // Show only warnings/alarms in a single line
            if (messages.length === 0) {
                const item = document.createElement('div');
                item.className = 'message-item message-info';
                item.textContent = '✅ System operating normally - No warnings';
                messageList.appendChild(item);
            } else {
                // Combine all warnings into a single line
                const warningTexts = messages.map(msg => msg.text.replace('⚠️ ', ''));
                const combinedWarning = document.createElement('div');
                combinedWarning.className = 'message-item message-alarm';
                combinedWarning.textContent = `⚠️ ${warningTexts.join(' • ')}`;
                messageList.appendChild(combinedWarning);
            }
        }
        
        // Toggle a digital output
        async function toggleDigitalOutput(pin) {
            const element = document.getElementById(`do-${pin}`);
            const currentValue = element.classList.contains('on');
            const newValue = !currentValue;
            
            try {
                const response = await fetch(`/digital/output/${pin}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ value: newValue })
                });
                
                if (response.ok) {
                    element.classList.remove('on', 'off');
                    element.classList.add(newValue ? 'on' : 'off');
                }
            } catch (error) {
                console.error('Error toggling digital output:', error);
            }
        }
        
        // Show modal for setting analog output
        function showAnalogModal(pin) {
            const modal = document.getElementById('analog-modal');
            const pinNumber = document.getElementById('analog-pin-number');
            const slider = document.getElementById('analog-value-slider');
            const valueDisplay = document.getElementById('analog-value-display');
            const setButton = document.getElementById('set-analog-value');
            
            // Get current value
            const valueText = document.getElementById(`ao-${pin}`).querySelector('.value').textContent;
            const currentValue = parseFloat(valueText);
            
            pinNumber.textContent = pin;
            slider.value = currentValue;
            valueDisplay.textContent = currentValue.toFixed(1);
            
            setButton.onclick = async () => {
                const value = parseFloat(slider.value);
                await setAnalogOutput(pin, value);
                modal.style.display = 'none';
            };
            
            modal.style.display = 'block';
        }
        
        // Set an analog output value
        async function setAnalogOutput(pin, value) {
            try {
                const response = await fetch(`/analog/output/${pin}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ value: value })
                });
                
                if (response.ok) {
                    const converted = convertAnalogValue(value, pin, true);
                    document.getElementById(`ao-${pin}`).querySelector('.value').textContent = `${converted.value}${converted.unit} (${value.toFixed(3)}V)`;
                }
            } catch (error) {
                console.error('Error setting analog output:', error);
            }
        }
        
        
        // Reset system to initial values
        async function resetSystem() {
            if (!confirm('Are you sure you want to reset the entire system to initial values? This will:\n\n• Turn off all digital outputs\n• Set all analog outputs to 0V\n• Reset all digital inputs to initial state\n• Clear cup, teaspoon positions, and weights\n\nThis action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    // Show success message
                    const messageList = document.getElementById('message-list');
                    messageList.innerHTML = '<div class="message-item message-info">🔄 System reset to initial values</div>';
                    
                    // Force immediate update
                    await fetchData();
                } else {
                    alert('Failed to reset system. Please try again.');
                }
            } catch (error) {
                console.error('Error resetting system:', error);
                alert('Error resetting system. Please check the connection.');
            }
        }
        
        // Initialize when the page loads
        window.addEventListener('DOMContentLoaded', initUI);
    </script>
</body>
</html>
